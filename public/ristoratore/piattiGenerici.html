<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FastFood - Piatti Generici</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      text-align: center;
      margin-bottom: 1rem;
    }
    .sidebar-header img {
      max-width: 150px;
    }
    .sidebar a.nav-link {
      color: #555;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      text-decoration: none;
    }
    .sidebar a.nav-link.active,
    .sidebar a.nav-link:hover {
      background-color: #fecd4c;
      color: #000;
    }
    .main-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    .main-content h2 {
      color: #00B5A2;
      margin-bottom: 1.5rem;
    }
    .filter-section {
      margin-bottom: 1rem;
    }
    .filter-section .mb-3 {
      margin-bottom: 1rem;
    }
    .meal-card {
      transition: transform 0.3s, box-shadow 0.3s;
      margin-bottom: 1rem;
    }
    .meal-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .meal-card img {
      height: 200px;
      object-fit: cover;
      border-top-left-radius: 0.375rem;
      border-top-right-radius: 0.375rem;
    }
    .meal-card .card-body {
      background-color: #fff;
      border-bottom-left-radius: 0.375rem;
      border-bottom-right-radius: 0.375rem;
    }
    .meal-card .card-title {
      color: #00B5A2;
      font-weight: bold;
    }
    .pagination-controls {
      margin-top: 1rem;
      text-align: center;
    }
    .pagination-controls input[type="number"] {
      width: 80px;
      text-align: center;
      margin: 0 0.5rem;
    }
  </style>
</head>
<body>
  <script>
    (function() {
      var token = localStorage.getItem("token");
      var role  = localStorage.getItem("role");
      if (!token || role !== "ristoratore") {
        window.location.href = "../login.html";
      }
    })();
  </script>
  
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="../assets/logo.png" alt="FastFood Logo">
    </div>
    <a href="home.html" class="nav-link">Dashboard</a>
    <a href="gestioneRistorante.html" class="nav-link">Gestisci Ristorante</a>
    <a href="piattiGenerici.html" class="nav-link active">Aggiungi Piatto Generico</a>
    <a href="piattoPersonalizzato.html" class="nav-link">Aggiungi Piatto Personalizzato</a>
    <a href="modificaPiattoPersonalizzato.html" class="nav-link">Modifica Piatto Personalizzato</a>
    <a href="ordini.html" class="nav-link">Ordini</a>
    <a href="statistiche.html" class="nav-link">Statistiche</a>
    <a href="../profilo.html" class="nav-link">Profilo</a>
    <a href="../logout.html" class="nav-link">Logout</a>

  </div>
  
  <div class="main-content">
    <h2>Piatti Generici</h2>
    
    <div class="filter-section">
      <div class="mb-3">
        <input type="text" id="filterName" class="form-control" placeholder="Filtra per nome">
      </div>
      <div class="mb-3">
        <select id="filterCategory" class="form-select">
          <option value="">Tutte le categorie</option>
        </select>
      </div>
      <div class="mb-3">
        <input type="number" id="filterPriceMin" class="form-control" placeholder="Prezzo Min">
      </div>
      <div class="mb-3">
        <input type="number" id="filterPriceMax" class="form-control" placeholder="Prezzo Max">
      </div>
      <div class="mb-3">
        <button id="applyFilter" class="btn btn-warning">Cerca</button>
      </div>
    </div>
    
    <div id="genericMealsContainer" class="row g-4"></div>
    
    <div id="paginationControls" class="pagination-controls"></div>
  </div>
  
  <script>
    var apiBase = "http://localhost:3000";
    var token = localStorage.getItem("token");
    var userId = localStorage.getItem("userId");
  
    var mioRistorante = null; 
    var filteredMeals = [];
    var genericMealsData = [];
    var currentPage = 1;
    var itemsPerPage = 6;

    async function fetchConControlloToken(url, options = {}) {
      var token = localStorage.getItem("token");
    
      if (!token) {
        window.location.href = "../logout.html";
        return;
      }
    
      options.headers = options.headers || {};
      options.headers["Authorization"] = "Bearer " + token;
    
      try {
        let response = await fetch(url, options);
    
        if (response.status === 401) { // token scaduto o invalido
            window.location.href = "../logout.html";
          }
    
        return response;
      } catch (error) {
        console.error("Errore nella richiesta API:", error);
        return null;
      }
    }
  
    async function caricaRistorante() {
      try {
        var response = await fetchConControlloToken(apiBase + "/restaurants", {
          headers: { "Authorization": "Bearer " + token }
        });
        var restaurants = await response.json();
        mioRistorante = restaurants.find(r => r.ristoratore_id && r.ristoratore_id.toString() === userId);
        
        if (!mioRistorante) {
          alert("Non hai ancora creato un ristorante. Vai alla pagina Gestisci Ristorante per crearlo.");
          window.location.href = "gestioneRistorante.html";
        }
      } catch (err) {
        console.error("Errore nel caricamento del ristorante:", err);
      }
    }
  
    var genericMealsData = [];

    async function caricaPiattiGenerici() {
      try {
        var response = await fetchConControlloToken(apiBase + "/meals");
        var meals = await response.json();

        genericMealsData = meals.filter(m => m.ristorante_id === null); 
        filteredMeals = [...genericMealsData]; 

        displayGenericMealsPage(1);
      } catch (err) {
        console.error("Errore nel caricamento dei piatti generici:", err);
      }
    }


    async function caricaCategorie() {
      var categorySelect = document.getElementById("filterCategory");

      if (!categorySelect) {
        console.error("Elemento select delle categorie non trovato!");
        return;
      }

      try {
        var response = await fetchConControlloToken(`${apiBase}/meals`);
        var meals = await response.json();

        var piattiGenerici = meals.filter(m => m.ristorante_id === null);
        var categorieUniche = [...new Set(piattiGenerici.map(m => m.strCategory).filter(Boolean))];

        categorieUniche.forEach(cat => {
          var option = document.createElement("option");
          option.text = cat;
          option.value = cat;
          categorySelect.add(option);
        });

      } catch (err) {
        console.error("Errore nel caricamento delle categorie:", err);
      }
    }

      function displayGenericMealsPage(page) {
      currentPage = page;
      var container = document.getElementById("genericMealsContainer");
      container.innerHTML = "";
      var startIndex = (page - 1) * itemsPerPage;
      var endIndex = startIndex + itemsPerPage;
      var pageItems = filteredMeals.slice(startIndex, endIndex);
  
      if (pageItems.length === 0) {
        container.innerHTML = '<p class="text-muted">Nessun piatto trovato.</p>';
      }
  
      pageItems.forEach(p => {
        var col = document.createElement("div");
        col.className = "col-md-6";
        col.innerHTML = `<div class="card meal-card h-100">
                          <img src="${p.strMealThumb}" class="card-img-top" alt="${p.strMeal}">
                          <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${p.strMeal}</h5>
                            <p class="card-text">${p.strCategory || ""}</p>
                            <p class="card-text"><strong>€ ${p.prezzo ? p.prezzo.toFixed(2) : "0.00"}</strong></p>
                            <button class="btn btn-outline-secondary mt-auto" onclick="aggiungiPiattoAlMenu('${p._id}')">Aggiungi al Menu</button>
                          </div>
                        </div>`;
        container.appendChild(col);
      });
  
      updatePaginationControls();
    }
  
    async function aggiungiPiattoAlMenu(idMeal) {
      if (!mioRistorante) {
        alert("Ristorante non trovato.");
        return;
      }
  
      if (mioRistorante.menu && mioRistorante.menu.includes(idMeal)) {
        alert("Questo piatto è già presente nel menu.");
        return;
      }
  
      var nuovoMenu = mioRistorante.menu ? [...mioRistorante.menu, idMeal] : [idMeal];
  
      var payload = {
        menu: nuovoMenu,
        updatedAt: new Date()
      };
  
      try {
        var updateRes = await fetchConControlloToken(apiBase + "/restaurants/" + mioRistorante._id, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });
  
        if (!updateRes.ok) {
          var errorText = await updateRes.text();
          throw new Error("HTTP " + updateRes.status + " - " + errorText);
        }
  
        mioRistorante.menu = nuovoMenu;
        alert("Piatto aggiunto al menu con successo!");
      } catch (err) {
        console.error("Errore:", err);
        alert(err.message);
      }
    }
  
    function updatePaginationControls() {
      var controls = document.getElementById("paginationControls");
      var totalPages = Math.ceil(filteredMeals.length / itemsPerPage);
      controls.innerHTML = `Pagina: <input type='number' id='pagePicker' min='1' max='${totalPages}' value='${currentPage}' step='1' /> di ${totalPages}`;
  
      document.getElementById("pagePicker").onchange = function() {
        var page = parseInt(this.value);
        if (page < 1) { page = 1; this.value = 1; }
        if (page > totalPages) { page = totalPages; this.value = totalPages; }
        displayGenericMealsPage(page);
      };
    }
  
    function applicaFiltri() {
      var nomeFiltro = document.getElementById("filterName").value.trim().toLowerCase();
      var categoriaFiltro = document.getElementById("filterCategory").value.trim().toLowerCase();
      var prezzoMin = parseFloat(document.getElementById("filterPriceMin").value) || 0;
      var prezzoMax = parseFloat(document.getElementById("filterPriceMax").value) || Number.MAX_VALUE;
  
      filteredMeals = genericMealsData.filter(function(p) {
        var nomeMatch = nomeFiltro === "" || (p.strMeal && p.strMeal.toLowerCase().includes(nomeFiltro));
        var categoriaMatch = categoriaFiltro === "" || (p.strCategory && p.strCategory.toLowerCase() === categoriaFiltro);
        var prezzoMatch = (p.prezzo >= prezzoMin && p.prezzo <= prezzoMax);
        return nomeMatch && categoriaMatch && prezzoMatch;
      });
  
      displayGenericMealsPage(1);
    }
  
    document.getElementById("applyFilter").addEventListener("click", applicaFiltri);
  
    (async function init() {
      await caricaRistorante();
      await caricaPiattiGenerici();
      await caricaCategorie();
    })();
  </script>
  
  
</body>
</html>
