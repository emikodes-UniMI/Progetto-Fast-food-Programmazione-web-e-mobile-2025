<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FastFood - Ordini Ristoratore</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #fff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      text-align: center;
      margin-bottom: 1rem;
    }
    .sidebar-header img {
      max-width: 150px;
    }
    .sidebar a.nav-link {
      color: #555;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      text-decoration: none;
    }
    .sidebar a.nav-link.active,
    .sidebar a.nav-link:hover {
      background-color: #fecd4c;
      color: #000;
    }
    .main-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    h2 {
      color: #00B5A2;
      margin-bottom: 1.5rem;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <img src="../assets/logo.png" alt="FastFood Logo">
  </div>
  <a href="home.html" class="nav-link">Dashboard</a>
  <a href="gestioneRistorante.html" class="nav-link">Gestisci Ristorante</a>
  <a href="piattiGenerici.html" class="nav-link">Aggiungi Piatto Generico</a>
  <a href="piattoPersonalizzato.html" class="nav-link">Aggiungi Piatto Personalizzato</a>
  <a href="modificaPiattoPersonalizzato.html" class="nav-link">Modifica Piatto Personalizzato</a>
  <a href="ordini.html" class="nav-link active">Ordini</a>
  <a href="statistiche.html" class="nav-link">Statistiche</a>
  <a href="../profilo.html" class="nav-link">Profilo</a>
  <a href="../logout.html" class="nav-link">Logout</a>

</div>

<div class="main-content">
  <h2>Ordini Ristoratore</h2>

  <br><hr><br>

  <h3>Ordini Attivi</h3>
  <div id="activeOrders"></div>

  <br><hr><br>

  <h3>Storico Ordini</h3>
  <div id="historyOrders"></div>
</div>

  <script>
    var apiBase = "http://localhost:3000";
    var token = localStorage.getItem("token");

    async function fetchConControlloToken(url, options = {}) {
      var token = localStorage.getItem("token");
    
      if (!token) {
        window.location.href = "../logout.html";
        return;
      }
    
      options.headers = options.headers || {};
      options.headers["Authorization"] = "Bearer " + token;
    
      try {
        let response = await fetch(url, options);
    
        if (response.status === 401) { // token scaduto o invalido
            window.location.href = "../logout.html";
          }
    
        return response;
      } catch (error) {
        console.error("Errore nella richiesta API:", error);
        return null;
      }
    }

    async function caricaOrdiniRistoratore() {
    try {
      var response = await fetchConControlloToken(apiBase + "/orders");

      var orders = await response.json();
      var activeOrders = document.getElementById("activeOrders");
      var historyOrders = document.getElementById("historyOrders");

      activeOrders.innerHTML = "";
      historyOrders.innerHTML = "";

      orders.forEach(order => {
        var orderDiv = document.createElement("div");
        orderDiv.className = "order-card";
        orderDiv.innerHTML = `
          <br>
          <p><strong>Ordine #${order._id}</strong></p>
          <p>Cliente: ${order.cliente_nome || "Sconosciuto"}</p>
          <p>Totale: €${order.totale.toFixed(2)}</p>
          <p>Data ordine: ${order.data_ordine}</p>
          <p>Tempo di attesa: ${order.tempo_attesa} min</p>
          <p>Metodo di consegna: ${order.metodo_consegna}</p>
          <p><b>Piatti:</b></p>
          <ul>
            ${order.meals.map(meal => `<li>${meal.nome} - Quantità: ${meal.quantita}</li>`).join("")}
          </ul>
          <p>Stato: <strong>${order.stato}</strong></p>
          <br>
        `;

        if (["ordinato", "in preparazione"].includes(order.stato)) {
          var updateBtn = document.createElement("button");
          updateBtn.className = "btn btn-warning";
          updateBtn.innerText = "Avanza Stato";
          updateBtn.onclick = () => cambiaStatoOrdine(order._id, order.stato);
          orderDiv.appendChild(updateBtn);
        }

        if (["ordinato", "in preparazione", "in consegna"].includes(order.stato)) {
          activeOrders.appendChild(orderDiv);
        } else {
          historyOrders.appendChild(orderDiv);
        }
      });

    } catch (err) {
      console.error("Errore nel caricamento degli ordini:", err);
    }
  }

  async function cambiaStatoOrdine(orderId, statoAttuale) {
    try {
      var response = await fetchConControlloToken(`${apiBase}/orders/${orderId}`, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        }
      });

      if (!response.ok) throw new Error("Errore nella modifica dello stato.");

      caricaOrdiniRistoratore();
    } catch (err) {
      console.error("Errore:", err);
    }
  }
    caricaOrdiniRistoratore();
  </script>
</body>
</html>
